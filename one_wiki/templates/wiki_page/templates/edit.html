<div class='edit-page-head'>

	<div class='edit-title'>
		<span class="h3" >{{ doc.title }}</span>
		<i>
			<svg class="icon icon-lg">
				<use href="#icon-edit"></use>
			</svg>
 		</i>
		<input type="text" class="hide">
	</div>
	
	
	<div class='btn btn-primary-light mr-3 draft-wiki-page'>{% if "ar" in lang%} مسودة التغييرات {% else %} Draft Changes{%- endif -%}</div>
	
</div>
<form class="mt-8 edit-form" method="POST">
	<input class="d-none" type="text" name="csrf_token" value="{{ frappe.session.csrf_token }}">
	<input class="d-none" type="text" name="wiki_page" value="{{ doc.name }}">
	<input class="d-none" type="text" name="wiki_page_patch" value="{{ wiki_page_patch or ''}}">
	<input class="d-none" type="text" name="new_sidebar_items" value='{{ new_sidebar_items or ""}}'>
	<input class="d-none" type="text" name="new" value="{{ frappe.form_dict.new or ''}}">

	<div class="form-group">

		<ul class="nav nav-tabs" role="tablist">

			<li class="nav-item" role="presentation">
				<a {% if not wiki_page_patch %} class="nav-link active" {% else %} class="nav-link" {% endif %}
					id="write-tab" data-toggle="tab" href="#write" role="tab" aria-controls="write"
					aria-selected="true">{% if "ar" in lang%} يكتب {% else %} Write {%- endif -%}</a>
			</li>

			<li class="nav-item" role="presentation">
				<a class="nav-link" id="preview-tab" data-toggle="tab" href="#preview" role="tab"
					aria-controls="preview" aria-selected="false">{% if "ar" in lang%} معاينة {% else %} Preview {%- endif -%}</a>
			</li>

			{%- if not frappe.form_dict.new -%}
			<li class="nav-item" role="presentation">
				<a class="nav-link" id="diff-tab" data-toggle="tab" href="#diff" role="tab" aria-controls="diff"
					aria-selected="false">{% if "ar" in lang%} قارن {% else %} Compare {%- endif -%}</a>
			</li>
			{%- endif -%}

			{% if wiki_page_patch %}
				
			<li class="nav-item" role="presentation">
				<a {% if wiki_page_patch %} class="nav-link active" {% else %} class="nav-link" {% endif %}
					id="discussion-tab" data-toggle="tab" href="#discussion" role="tab" aria-controls="discussion"
					aria-selected="false">{% if "ar" in lang%} مناقشة {% else %} Discussion {%- endif -%}</a>
			</li>
			
			{% endif %}

			<li class="nav-item" role="presentation">
				<a class="nav-link" id="help-tab" data-toggle="tab" href="#help" role="tab"
					aria-controls="help" aria-selected="false">{% if "ar" in lang%} مساعدة {% else %} Help {%- endif -%}</a>
			</li>

		</ul>

		<div class="mt-4 tab-content">

			<div {% if not wiki_page_patch %} class="tab-pane fade show active" {% else %} class="tab-pane fade" {%
				endif %} id="write" role="tabpanel" aria-labelledby="write-tab">
				<div class="form-control wiki-content-md" hidden>{{ content_md }}</div>
				<div class="form-control wiki-content-html" hidden>{{ content_html }}</div>
				<div class="wiki-write"></div>
			</div>

			<div class="tab-pane fade" id="preview" role="tabpanel" aria-labelledby="preview-tab">
				<div class="from-markdown wiki-preview"></div>
			</div>

			{%- if not frappe.form_dict.new -%}
			<div class="tab-pane fade" id="diff" role="tabpanel" aria-labelledby="preview-tab">
				{% if "ar" in lang%}<h4>الصفحة المحررة </h4>{% else %} <h4>Edited Page</h3>{%- endif -%}
				
				<div class="from-markdown wiki-diff"></div>
				{%- if sidebar_edited -%}
				<hr>
				{% if "ar" in lang%}<h4>تحرير الشريط الجانبي</h4> </h4>{% else %} <h4>Edited Sidebar</h3>{%- endif -%}
				<div class=" sidebar-diff"></div>
				{%- endif -%}

			</div>

			{%- endif -%}

			{% if wiki_page_patch %}
			
			<div {% if wiki_page_patch %} class="tab-pane fade show active" {% else %} class="tab-pane fade" {% endif %}
				id="discussion" role="tabpanel" aria-labelledby="discussion-tab">
				{% include "wiki/doctype/wiki_page/templates/comment.html" %}
			</div>
			
			{% endif %}

			<div class="tab-pane fade" id="help" role="tabpanel" aria-labelledby="help-tab">
				<div class="wiki-help">
					<ul>
						<li> Items in the left sidebar can be reordered by dragging and dropping.</li>
						<li> Choose the dropdown above the editor to try out the Rich Text Editor.</li>
						<li>Choose the dropdown above the editor to try out the Rich Text Editor.</li>
						<li>In the "markdown mode' images can be uploaded using the upload image button, and links can be copied using the attachments list.</li>
						<li>Click on the draft changes button to save your work as a draft.</li>
						<li>You can view your drafts and pending contributions by clicking on the appropriate links under profile in the top right corner.</li>
						<li>If you create a new page, you will find an entry named New Wiki Page in the left sidebar, which can also be moved.</li>
					</ul>
				</div>
			</div>

		</div>

	</div>
</form>

{% block base_scripts %}

<!-- js should be loaded in body! -->
<script type="text/javascript" src="/assets/frappe/js/lib/jquery/jquery.min.js"></script>
<script src="https://unpkg.com/turndown@7.0.0/dist/turndown.js"></script>
{{ include_script('libs.bundle.js') }}

{{ include_script('frappe-web.bundle.js') }}
{{ include_script('controls.bundle.js') }}
{{ include_script('dialog.bundle.js') }}
{{ include_script('bootstrap-4-web.bundle.js') }}
<script type="text/javascript" src="/assets/frappe/node_modules/moment/min/moment-with-locales.min.js"></script>
<script type="text/javascript"
	src="/assets/frappe/node_modules/moment-timezone/builds/moment-timezone-with-data.min.js"></script>
{{ include_script('desk.bundle.js') }}
{{ include_script('file_uploader.bundle.js') }}
{{ include_script('wiki_override.bundle.js') }}




<script>

	//Hide submit button
//$('.submit-wiki-page').hide()
$(".breadcrumb-container").append('<div class ="approval_row"> <button type="button" id = "approve" class="btn btn-primary btn-sm">Approve Draft</button><button type="button"  id = "reject" class="btn btn-secondary btn-sm">Reject Draft</button></div>')
$('.approval_row').css('position','absolute')
$('.approval_row').css('right','9%')
$('.approval_row').css('top','13%')
$('#reject').css('background-color','red')
$('#reject').css('color','white')
$('.approval_row').hide()

	function can_edit_wiki(page_patch = null){
		
		setTimeout(()=>{
			frappe.call({
				method: "one_wiki.overrides.wiki_page.fetch_details",	
				args:{
					page_patch:page_patch
				},
				callback: function(r) {
						
						if(r.message[0]){
							;
						}
						else{
							let current_location = window.location.href
							if(current_location.endsWith('edit-wiki')|| current_location.endsWith('edit-wiki/')){
								//check if the current user has edit permissions
								
								let new_location = current_location.split('edit-wiki')[0]
								if(new_location){
									
									window.location.href = new_location
								}
							}
							else if(current_location.endsWith('new-wiki')|| current_location.endsWith('new-wiki/')){
								//check if the current user has edit permissions
								
								let new_location = current_location.split('new-wiki')[0]
								
								if(new_location){
									
									window.location.href = new_location
								}
							}
							else{
								let _location = current_location.split('?')[0]
								new_location = _location.split('edit-wiki')[0]
								
								if(new_location){
									window.location.href = new_location
								}
							}
						}
						
						if(r.message[1]){
							$('.approval_row').show()
						}
						
					}
				
			});
		}, 1200);
		
	}
	function has_edit_permission(){
		// confirm if the current page is a plain edit/new page or the edit page of a wiki page patch
		let current_location = window.location.href
		if(current_location.endsWith('edit-wiki')|| current_location.endsWith('edit-wiki/')){
			//check if the current user has edit permissions
			
			let new_location = current_location.split('edit-wiki')[0]
			
			if(new_location){
				can_edit_wiki()
			}
		}
		else if(current_location.endsWith('new-wiki')|| current_location.endsWith('new-wiki/')){
			//check if the current user has edit permissions
			
			let new_location = current_location.split('new-wiki')[0]
			
			if(new_location){
				can_edit_wiki()
				
			}
		}
		else{
			//fetch the wiki page patch id and check if the current user has approve permission
			let _patch = current_location.split('?')[1]
			let patch_id = _patch.split('=')[1]
			
			
			if(patch_id){
				can_edit_wiki(patch_id)
			}

		}
	}
	has_edit_permission()
	function fetch_approver(){
		;
		// check if the current user has approving rights 
	}

	if('{{show_approval}}'=="True"){
		$('.approval_row').show()
	}
	
	
	let frappe_version = "{{ frappe_version }}";
	if (parseInt(frappe_version.split(".")[0]) <= 14 && !frappe_version.endsWith("-dev")) {
		Vue.prototype.__ = window.__;
		Vue.prototype.frappe = window.frappe;
	}

	frappe.boot = {{ boot }};
	var language = frappe.boot.lang
	if(language =="ar"){
		new EditWikiAr();
		
		
		var edit = new EditAssetAr();
		
	}
	else{
		new EditWiki();
		
		
		var edit = new EditAsset();
		
	}
	
	$('.ellipsis').val('{{wiki_language}}')
</script>

{%- if frappe.form_dict.new -%}

{%- if script -%}
<script>{ { script } }</script>
{%- endif -%}

{%- endif -%}
<script>
	
	function update_dom(){
		if('{{lang}}'=='ar'){
            $('html').attr('dir','rtl')
        }
        else{
            lang_ ='en'
            $('html').attr('dir','ltr')
        }
		$('.ml-auto').append(`
        <li class="nav-item dropdown logged-in" id="website-post-login" data-label="website-post-login" style="">
			<a href="#" class="nav-link nav-avatar" data-toggle="dropdown" aria-expanded="false">
						<span class="langauge-wrapper">
							<span class="avatar avatar-medium filterable" title="Language:{{lang}}" data-filter="_assign,like,%null%">
							<div id = "lang_icon" class="avatar-frame standard-image" style="background-color: var(--green-avatar-bg); color: var(--green-avatar-color)">
									{{lang_}}</div>
							</span>
						</span>
					</a>
					<ul class = "dropdown-menu dropdown-menu-right" id = "language_selector">
						<ul class="dropdown-menu dropdown-menu-right show" role="menu">
							<a id = "eng_lang" class="dropdown-item" href="#" rel="nofollow">English</a>
							<a id = "ar_lang" class="dropdown-item" href="#" rel="nofollow">عربي</a>
						</ul>
					</ul>
                </li>    
    `)
	let language = frappe.boot.lang
	if(language.includes('en')){
		$('#lang_icon').html('en')
	}
	else{
		$('#lang_icon').html(language)
	}

	
	}
	
	update_dom()
	
	$("#eng_lang").click(()=>{
		change_lang("en")
	})

	$("#ar_lang").click(()=>{
		change_lang("ar")
	})
	$("#approve").click(()=>{
		let me = this
		
		me.edit.get_markdown()
	})

	$("#reject").click(()=>{
		update_patch("Rejected")
	})

function update_patch(decision){
	
	frappe.call({
		method: "one_wiki.overrides.wiki_page.update_patch",
		args: {
			decision: decision,
			wiki_patch: '{{ wiki_page_patch or ''}}'
			
		},
		freeze: true,
		
		callback: function(r) {
				if(r.message){
					
					back_to_wiki()
				}
				else{
					frappe.msgprint("An error occured while updating the draft. Please contact system administrator")
				}
				
			}
		
	});
}

function back_to_wiki(route=undefined){
	
		let current_location = window.location.href
		if(current_location.endsWith('edit-wiki')|| current_location.endsWith('edit-wiki/')){
			let new_location = current_location.split('edit-wiki')[0]
			if(new_location){
				window.location.href = new_location
				
		}
		}
		else if(current_location.endsWith('new-wiki')|| current_location.endsWith('new-wiki/')){
			let new_location = current_location.split('new-wiki')[0]
			if(new_location){
				window.location.href = new_location
			}
		}
		else{
			let _location = current_location.split('?')[0]
			new_location = _location.split('edit-wiki')[0]
			if(new_location){
				window.location.href = new_location
		}

		}
}
			   
function change_lang(lang){
	
	frappe.call({
		method: "one_wiki.overrides.wiki_page.change_language",
		args: {
			lang: lang,
			user: frappe.session.user,
			
		},
		freeze: true,
		
		callback: function(r) {
				if(r.message){
					let lang_ = ''
                        if(lang=='en'){
                             lang_ = 'English'
                        }
                        else{
                             lang_ = "Arabic"
                        }
					
					location.reload();
				}
				else{
					frappe.msgprint("An Error occured while changing languages, Please review the error log.")
				}
				
			}
		
	});
}      
</script>
{% endblock %}